#!/usr/bin/env bash
set -e

# ===== å‚æ•° =====
AGG_ROOT="$1"        # èšåˆä»“åº“æ ¹ç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰
REPO_NAME="$2"       # GitHub ä»“åº“å
TARGET_PATH="$3"     # ç›¸å¯¹ AGG_ROOT çš„è·¯å¾„
VISIBILITY="${4:-private}"

if [ -z "$AGG_ROOT" ] || [ -z "$REPO_NAME" ] || [ -z "$TARGET_PATH" ]; then
  echo "Usage:"
  echo "  add-submodule-plus <agg_root> <repo_name> <target_path> [public|private]"
  exit 1
fi

# ===== æ ¡éªŒèšåˆä»“åº“ =====
if [ ! -d "$AGG_ROOT/.git" ]; then
  echo "âŒ $AGG_ROOT is not a git repository"
  exit 1
fi

# ===== gh æ ¡éªŒ =====
command -v gh >/dev/null 2>&1 || { echo "âŒ gh not installed"; exit 1; }
if ! gh auth status >/dev/null 2>&1; then
  echo "âŒ gh not authenticated"
  exit 1
fi

# ===== GitHub ç”¨æˆ· =====
GH_USER=$(gh api user --jq .login)
REPO_URL="https://github.com/${GH_USER}/${REPO_NAME}.git"

echo "ğŸš€ Creating GitHub repository: ${GH_USER}/${REPO_NAME} (${VISIBILITY})"
gh repo create "${GH_USER}/${REPO_NAME}" --"${VISIBILITY}" --confirm

# ===== åˆå§‹åŒ–å­ä»“åº“ï¼ˆä¸´æ—¶ç›®å½•ï¼‰=====
TMP_DIR=$(mktemp -d)
git clone "$REPO_URL" "$TMP_DIR"

cd "$TMP_DIR"
echo "# ${REPO_NAME}" > README.md
echo "" >> README.md
echo "Auto-generated by add-submodule-plus." >> README.md

git add README.md
git commit -m "init: first commit"
git branch -M main
git push -u origin main

cd - >/dev/null
rm -rf "$TMP_DIR"

# ===== æ·»åŠ  submodule =====
cd "$AGG_ROOT"

echo "â• Adding submodule at ${TARGET_PATH}"
git submodule add "$REPO_URL" "$TARGET_PATH"

git add .gitmodules "$TARGET_PATH"
git commit -m "chore: add submodule ${REPO_NAME}"

echo "âœ… Done!"
echo "   Repo: ${REPO_URL}"
echo "   Aggregation root: ${AGG_ROOT}"
echo "   Submodule path: ${TARGET_PATH}"
