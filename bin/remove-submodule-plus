#!/usr/bin/env bash
set -e

AGG_ROOT="$1"      # èšåˆä»“åº“æ ¹ç›®å½•
SUBMODULE_PATH="$2" # ç›¸å¯¹ AGG_ROOT çš„ submodule è·¯å¾„

if [ -z "$AGG_ROOT" ] || [ -z "$SUBMODULE_PATH" ]; then
  echo "Usage: remove-submodule-plus <agg_root> <submodule_path>"
  exit 1
fi

if [ ! -d "$AGG_ROOT/.git" ]; then
  echo "âŒ $AGG_ROOT is not a git repository"
  exit 1
fi

cd "$AGG_ROOT"

# æ£€æŸ¥ submodule æ˜¯å¦å­˜åœ¨
if ! grep -q "\[submodule \"$SUBMODULE_PATH\"\]" .gitmodules; then
  echo "âŒ Submodule $SUBMODULE_PATH not found in .gitmodules"
  exit 1
fi

echo "ğŸ§¹ Removing submodule $SUBMODULE_PATH"

# 1ï¸âƒ£ åˆ é™¤ git é…ç½®
git submodule deinit -f "$SUBMODULE_PATH"

# 2ï¸âƒ£ åˆ é™¤ .gitmodules æ¡ç›®
git rm -f "$SUBMODULE_PATH"

# 3ï¸âƒ£ åˆ é™¤å­æ¨¡å—æ®‹ç•™ç›®å½•
rm -rf "$SUBMODULE_PATH"

# 4ï¸âƒ£ æäº¤çˆ¶ä»“åº“
git commit -m "chore: remove submodule $SUBMODULE_PATH"

echo "âœ… Submodule $SUBMODULE_PATH removed successfully"
